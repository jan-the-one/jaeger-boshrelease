#!/bin/bash

set -e
set -u

source /var/vcap/jobs/nginx/config/export_env.sh
source ${JOB_DIR}/helpers/utils.sh

log 'Creating directories'
for dir in ${RUN_DIR} ${LOG_DIR} ${TMP_DIR}; do
  mkdir -p ${dir}
  chown vcap:vcap ${dir}
done
log 'Finished creating directories'

log 'Creating cert files for upstreams'
<% p('upstreams').each do |upstream| %>
  <% if upstream['ssl_cert'] && upstream['ssl_key'] %>
cat > /var/vcap/jobs/nginx/config/<%= upstream['name'] %>_cert.pem << EOL
<%= upstream['ssl_cert'] %>
<%= upstream['ssl_ca'] %>
EOL

cat > /var/vcap/jobs/nginx/config/<%= upstream['name'] %>_key.pem << EOL
<%= upstream['ssl_key'] %>
EOL
  <% end %>

  <% if upstream['ssl_verify_client'] && upstream['ssl_client_certificate'] %>
cat > /var/vcap/jobs/nginx/config/<%= upstream['name'] %>_client_cert.pem << EOL
<%= upstream['ssl_client_certificate'] %>
EOL
  <% end %>
<% end %>
log 'Finished creating cert files for upstreams'
